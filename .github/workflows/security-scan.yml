# =============================================================================
# .github/workflows/security-scan.yml
# Security Scanning Semanal
# =============================================================================
name: Weekly Security Scan

on:
  schedule:
    - cron: '0 2 * * 1'  # Lunes a las 2 AM
  workflow_dispatch:  # Manual trigger

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Run OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'AMA-Intent'
          path: '.'
          format: 'HTML'
          out: 'dependency-check-report'
      
      - name: Upload dependency check report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: dependency-check-report/

---

# =============================================================================
# .github/workflows/backup-verify.yml
# Verificación de Backups Diaria
# =============================================================================
name: Daily Backup Verification

on:
  schedule:
    - cron: '0 3 * * *'  # Diario a las 3 AM
  workflow_dispatch:

jobs:
  verify-backups:
    name: Verify Production Backups
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SSH_KEY }}
      
      - name: Verify latest backup
        env:
          PROD_HOST: ${{ secrets.PRODUCTION_HOST }}
          PROD_USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no $PROD_USER@$PROD_HOST << 'EOF'
            cd /opt/ama-intent
            docker-compose exec -T backup python /app/verify_backup.py --latest
          EOF
      
      - name: Test backup restoration (staging)
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no $STAGING_USER@$STAGING_HOST << 'EOF'
            cd /opt/ama-intent
            docker-compose exec -T backup python /app/restore_test.py --from-production
          EOF
      
      - name: Notify on failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "⚠️ Backup Verification Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Backup Verification Alert*\n❌ Daily backup verification failed!\nCheck logs immediately."
                  }
                }
              ]
            }

---

# =============================================================================
# .github/workflows/documentation.yml
# Generación y Deploy de Documentación
# =============================================================================
name: Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '**.md'
  workflow_dispatch:

jobs:
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install MkDocs
        run: |
          pip install mkdocs mkdocs-material mkdocs-mermaid2-plugin
      
      - name: Build documentation
        run: |
          mkdocs build --strict
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site

---

# =============================================================================
# .github/workflows/docker-cleanup.yml
# Limpieza de Imágenes Docker Antiguas
# =============================================================================
name: Docker Cleanup

on:
  schedule:
    - cron: '0 4 * * 0'  # Domingos a las 4 AM
  workflow_dispatch:

jobs:
  cleanup:
    name: Clean Old Docker Images
    runs-on: ubuntu-latest
    
    permissions:
      packages: write
    
    steps:
      - name: Delete old container images
        uses: actions/delete-package-versions@v5
        with:
          package-name: 'ama-intent'
          package-type: 'container'
          min-versions-to-keep: 10
          delete-only-untagged-versions: 'true'

---

# =============================================================================
# .github/workflows/metrics-report.yml
# Reporte de Métricas Semanal
# =============================================================================
name: Weekly Metrics Report

on:
  schedule:
    - cron: '0 9 * * 1'  # Lunes a las 9 AM
  workflow_dispatch:

jobs:
  generate-report:
    name: Generate Metrics Report
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests pandas matplotlib
      
      - name: Fetch metrics from Prometheus
        env:
          PROMETHEUS_URL: ${{ secrets.PROMETHEUS_URL }}
        run: |
          python scripts/fetch_metrics.py \
            --start $(date -d '7 days ago' +%s) \
            --end $(date +%s) \
            --output weekly-metrics.json
      
      - name: Generate report
        run: |
          python scripts/generate_report.py \
            --input weekly-metrics.json \
            --output weekly-report.pdf
      
      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: weekly-metrics-report
          path: weekly-report.pdf
      
      - name: Send report via email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'AMA-Intent Weekly Metrics Report'
          to: ${{ secrets.REPORT_RECIPIENTS }}
          from: AMA-Intent CI/CD
          body: 'Weekly metrics report attached'
          attachments: weekly-report.pdf

---

# =============================================================================
# .github/workflows/database-migration.yml
# Workflow para Migraciones de Base de Datos
# =============================================================================
name: Database Migration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      migration_type:
        description: 'Migration type'
        required: true
        type: choice
        options:
          - upgrade
          - downgrade
          - sddcs-schema

jobs:
  migrate:
    name: Run Database Migration
    runs-on: ubuntu-latest
    
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets[format('{0}_SSH_KEY', upper(github.event.inputs.environment))] }}
      
      - name: Create backup before migration
        env:
          TARGET_HOST: ${{ secrets[format('{0}_HOST', upper(github.event.inputs.environment))] }}
          TARGET_USER: ${{ secrets[format('{0}_USER', upper(github.event.inputs.environment))] }}
        run: |
          ssh -o StrictHostKeyChecking=no $TARGET_USER@$TARGET_HOST << 'EOF'
            cd /opt/ama-intent
            docker-compose exec -T ama-dashboard python scripts/backup_db.py --pre-migration
          EOF
      
      - name: Run migration
        env:
          TARGET_HOST: ${{ secrets[format('{0}_HOST', upper(github.event.inputs.environment))] }}
          TARGET_USER: ${{ secrets[format('{0}_USER', upper(github.event.inputs.environment))] }}
          MIGRATION_TYPE: ${{ github.event.inputs.migration_type }}
        run: |
          ssh -o StrictHostKeyChecking=no $TARGET_USER@$TARGET_HOST << EOF
            cd /opt/ama-intent
            
            if [ "$MIGRATION_TYPE" = "sddcs-schema" ]; then
              docker-compose exec -T ama-dashboard python scripts/sddcs_migration.py
            elif [ "$MIGRATION_TYPE" = "upgrade" ]; then
              docker-compose exec -T ama-dashboard python scripts/migrate_and_upgrade.py
            else
              docker-compose exec -T ama-dashboard python scripts/downgrade_db.py
            fi
          EOF
      
      - name: Verify migration
        env:
          TARGET_HOST: ${{ secrets[format('{0}_HOST', upper(github.event.inputs.environment))] }}
          TARGET_USER: ${{ secrets[format('{0}_USER', upper(github.event.inputs.environment))] }}
        run: |
          ssh -o StrictHostKeyChecking=no $TARGET_USER@$TARGET_HOST << 'EOF'
            cd /opt/ama-intent
            docker-compose exec -T ama-dashboard python scripts/verify_db_schema.py
          EOF
      
      - name: Rollback on failure
        if: failure()
        env:
          TARGET_HOST: ${{ secrets[format('{0}_HOST', upper(github.event.inputs.environment))] }}
          TARGET_USER: ${{ secrets[format('{0}_USER', upper(github.event.inputs.environment))] }}
        run: |
          ssh -o StrictHostKeyChecking=no $TARGET_USER@$TARGET_HOST << 'EOF'
            cd /opt/ama-intent
            docker-compose exec -T ama-dashboard python scripts/restore_db.py --from-pre-migration
          EOF
      
      - name: Notify result
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "Database Migration: ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Database Migration*\nEnvironment: ${{ github.event.inputs.environment }}\nType: ${{ github.event.inputs.migration_type }}\nStatus: ${{ job.status }}"
                  }
                }
              ]
            }